@model OnlineBanking.Models.Transaction

@{
    ViewData["Title"] = "Send/Request";
    var _context = ViewBag.Context as OnlineBankingContext;
}

<!-- Secondary menu
  ============================================= -->
<div class="bg-primary">
    <div class="container d-flex justify-content-center">
        <ul class="nav secondary-nav">
            <li class="nav-item"> <a class="nav-link active" asp-area="UserSection" asp-controller="Send" asp-action="Index">Send</a></li>
            <li class="nav-item"> <a class="nav-link" asp-area="UserSection" asp-controller="Cheques" asp-action="Index">Request</a></li>
        </ul>
    </div>
</div>
<!-- Secondary menu end -->
<!-- Content
============================================= -->
<div id="content" class="py-4">
    <div class="container">
        <h2 class="font-weight-400 text-center mt-3">Send Money</h2>
        <p class="text-4 text-center mb-4">Send your money on anytime, anywhere in the world.</p>
        <div class="row">
            <div class="col-md-8 col-lg-6 col-xl-5 mx-auto">
                <div class="bg-light shadow-sm rounded p-3 p-sm-4 mb-4">
                    <h3 class="text-5 font-weight-400 mb-3">Personal Details</h3>




                    <!-- Send Money Form
                    ============================================= -->
                    <form id="form-send-money" asp-area="UserSection" asp-controller="Send" asp-action="SendConfirm" method="post">
                        <!--Account From-->
                        <div class="form-group">
                            <div class="input-group-append">
                                <span class="input-group-text p-0">
                                    <select id="SenderAccountList" data-style="custom-select bg-transparent border-0" data-container="body" class="selectpicker form-control bg-transparent" onchange="changeSenderAccount()">
                                        <optgroup label="All Your Address Book">
                                            @foreach (Account acc in ViewBag.AccountList)
                                            {
                                                <option value="@acc.Number">@acc.Number -- @acc.AccountType.Name</option>
                                            }
                                        </optgroup>
                                    </select>
                                </span>
                            </div>
                        </div>


                        <!--Account Gets-->
                        <div class="form-group">
                            <label>To Account</label>
                            <input name="AccountGet" type="text" value="@ViewBag.AccountRecipientDefault" class="form-control" data-bv-field="emailid" id="RecipientNumber" required placeholder="Enter Recipient's Account Number"></input>
                            
                            <div class="input-group-append">
                                <span class="input-group-text p-0">
                                    <select id="AddressBook" data-style="custom-select bg-transparent border-0" data-container="body" class="selectpicker form-control bg-transparent" onchange="fillRecipientNumber()">
                                        <optgroup label="All Your Address Book">
                                            @foreach (AddressBook address in ViewBag.AllAddressBookById)
                                            {
                                                <option value="@address.Account.Number">@address.Account.Number -- @address.Account.User.FullName</option>
                                            }
                                        </optgroup>
                                    </select>
                                </span>
                            </div>
                        </div>



                        <div class="form-group">
                            <label for="youSend">You Send</label>
                            <div class="input-group">
                                <div class="input-group-prepend"> <span class="input-group-text">$</span> </div>
                                <input name="AmountSend" asp-for="Amount" class="form-control" data-bv-field="youSend" id="youSend" value="100" oninput="caculateCurrency(); caculateTotal()">
                                <div class="input-group-append">
                                    <span class="input-group-text p-0">
                                        <select id="youSendCurrency" data-style="custom-select bg-transparent border-0" data-container="body" data-live-search="true" class="selectpicker form-control bg-transparent" onchange="caculateCurrency(); currentExchangePer1(); caculateTotal(); changeSenderCurrency()">
                                            <optgroup label="All Currency">
                                                @foreach (Currency currency in ViewBag.lstCurrencies)
                                                {
                                                    //Chuyển dổi chữ hoa thành chữ thường để hiện thị icon currency trong bootstrap
                                                    char[] arr;
                                                    arr = currency.Name.ToCharArray();//Chuyển thành mảng ký tự

                                                    for (int i = 0; i < 3; i++)
                                                    {
                                                        arr[i] = Char.ToLower(arr[i]);
                                                    }
                                                    String strTemp = new String(arr);
                                                    //Hoàn tất chuyển đổi

                                                    <!--Hiển thị-->
                                                    <option data-icon="currency-flag currency-flag-@strTemp mr-1" value="@currency.ExchangeRate.ToString()">@currency.Name</option>
                                                }
                                            </optgroup>
                                        </select>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipientGets">Recipient Gets</label>
                            <div class="input-group">
                                <div class="input-group-prepend"> <span class="input-group-text">$</span> </div>
                                <input type="text" class="form-control" data-bv-field="recipientGets" id="recipientGets" oninput="caculateCurrencyForSender(); caculateTotal()">
                                <div class="input-group-append">
                                    <span class="input-group-text p-0">
                                        <select id="recipientCurrency" data-style="custom-select bg-transparent border-0" data-container="body" data-live-search="true" class="selectpicker form-control bg-transparent" onchange="caculateCurrency(); currentExchangePer1(); caculateTotal()">
                                            <optgroup label="All Currency">
                                                @foreach (Currency currency in ViewBag.lstCurrencies)
                                                {
                                                    //Chuyển dổi chữ hoa thành chữ thường để hiện thị icon currency trong bootstrap
                                                    char[] arr;
                                                    arr = currency.Name.ToCharArray();//Chuyển thành mảng ký tự

                                                    for (int i = 0; i < 3; i++)
                                                    {
                                                        arr[i] = Char.ToLower(arr[i]);
                                                    }
                                                    String strTemp = new String(arr);
                                                    //Hoàn tất chuyển đổi

                                                    <!--Hiển thị-->
                                                    <option data-icon="currency-flag currency-flag-@strTemp mr-1" value="@currency.ExchangeRate">@currency.Name</option>
                                                }
                                            </optgroup>
                                        </select>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p id="Note" class="text-muted text-center">The current exchange rate is 1 USD = 1.00000 USD</p>
                        <input id="SenderCurrency" type="hidden" name="SenderCurrency" value="USD" />

                        <!--xét giá trị mặc định cho tài khoản gửi đi vì có thể phát sinh lỗi-->
                        
                        <input id="SenderAccount" type="hidden" name="AccountFrom" value="@ViewBag.AccountDefault.Number" />
                        <hr>
                        <p class="font-weight-500">Total To Pay <span class="text-3 float-right" id="TotalToPay">0.00 USD</span></p>
                        <button class="btn btn-primary btn-block">Continue</button>
                    </form>
                    <!-- Send Money Form end -->



                </div>
            </div>
        </div>
    </div>
</div>
<!-- Content end -->


@{/* Cái này để format lại, mà chưa biết làm thế nào, để đó t hỏi thử
      double a = 2300000.32;
      <h1>@a.ToString("#,##0.000")</h1>
  */
}



<script>
    function caculateCurrency() {
        var ketQua = (parseFloat(document.getElementById("youSend").value) * parseFloat(document.getElementById("youSendCurrency").value)) / parseFloat(document.getElementById('recipientCurrency').value);
        document.getElementById("recipientGets").value = ketQua.toFixed(3);
    }

    function caculateCurrencyForSender() {
        var ketQua = (parseFloat(document.getElementById("recipientGets").value) * parseFloat(document.getElementById("recipientCurrency").value)) / parseFloat(document.getElementById('youSendCurrency').value);
        document.getElementById("youSend").value = ketQua.toFixed(3);
    }

    function fillRecipientNumber() {
        document.getElementById("RecipientNumber").value = document.getElementById("AddressBook").value;
    }

    function currentExchangePer1() {

        var selSender = document.getElementById("youSendCurrency");
        var selRecipient = document.getElementById("recipientCurrency");
        var conversionCoefficient = parseFloat(document.getElementById("youSendCurrency").value) / parseFloat(document.getElementById("recipientCurrency").value);

        document.getElementById("Note").innerHTML = "The current exchange rate is 1 " + selSender.options[selSender.selectedIndex].text + " = " + conversionCoefficient.toFixed(5) + " " + selRecipient.options[selRecipient.selectedIndex].text;
    }

    function caculateTotal() {
        var selSender = document.getElementById("youSendCurrency");
        document.getElementById("TotalToPay").innerHTML = document.getElementById("youSend").value + " " + selSender.options[selSender.selectedIndex].text;
    }

    function changeSenderCurrency() {
        var selSender = document.getElementById("youSendCurrency");
        document.getElementById("SenderCurrency").value = selSender.options[selSender.selectedIndex].text;
    }

    function changeSenderAccount() {
        var selSender = document.getElementById("SenderAccountList");
        document.getElementById("SenderAccount").value = selSender.value;
    }

</script>








